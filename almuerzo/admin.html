<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Sistema de Almuerzo</title>
    <link rel="icon" href="../images/logo.png" type="image/x-icon" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/almuerzo.css">
</head>
<body>
    <!-- Header -->
    <div class="almuerzo-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <img src="../images/logo.png" alt="Logo Empaques Múltiples" class="logo">
                </div>
                <div class="col-md-6">
                    <div class="user-info">
                        <div class="user-name">
                            <i class="fas fa-user-shield"></i> Administrador
                        </div>
                        <div class="user-email" id="userEmail"></div>
                        <button class="btn btn-sm btn-outline-danger mt-2" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="almuerzo-container">
        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card fade-in">
                    <div class="stat-number" id="statHoy">-</div>
                    <div class="stat-label">Asistencias Hoy</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card fade-in">
                    <div class="stat-number" id="statMes">-</div>
                    <div class="stat-label">Este Mes</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card fade-in">
                    <div class="stat-number" id="statTotal">-</div>
                    <div class="stat-label">Total Histórico</div>
                </div>
            </div>
        </div>

        <!-- Filtros y Exportación -->
        <div class="filter-section fade-in">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i> Fecha Inicio
                    </label>
                    <input type="date" class="form-control" id="fechaInicio">
                </div>
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i> Fecha Fin
                    </label>
                    <input type="date" class="form-control" id="fechaFin">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" onclick="aplicarFiltro()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100" onclick="exportarDatos()">
                        <i class="fas fa-file-excel"></i> Exportar a Excel
                    </button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-secondary" onclick="limpiarFiltros()">
                        <i class="fas fa-times"></i> Limpiar Filtros
                    </button>
                    <button class="btn btn-info" onclick="verHoy()">
                        <i class="fas fa-calendar-day"></i> Ver Hoy
                    </button>
                </div>
            </div>
        </div>

        <!-- Menú Semanal -->
        <div class="card fade-in mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-burger"></i> Menú Semanal del Almuerzo
                </span>
                <button class="btn btn-sm btn-outline-primary" onclick="cargarMenu()">
                    <i class="fas fa-rotate"></i> Recargar
                </button>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Lunes</label>
                        <textarea id="menu_lunes" class="form-control" rows="2" placeholder="Ej. Sopa, arroz, pollo, ensalada"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Martes</label>
                        <textarea id="menu_martes" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Miércoles</label>
                        <textarea id="menu_miercoles" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Jueves</label>
                        <textarea id="menu_jueves" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Viernes</label>
                        <textarea id="menu_viernes" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Sábado</label>
                        <textarea id="menu_sabado" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Domingo</label>
                        <textarea id="menu_domingo" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary" onclick="guardarMenu()">
                        <i class="fas fa-save"></i> Guardar Menú
                    </button>
                    <div id="menuStatus" class="text-muted"></div>
                </div>
            </div>
        </div>

        <!-- Gestión de Usuarios -->
        <div class="card fade-in mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-users-cog"></i> Gestión de Usuarios
                </span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Usuario</label>
                        <input type="text" id="nuevo_usuario" class="form-control" placeholder="Ej. jperez">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nombre y Apellido</label>
                        <input type="text" id="nuevo_nombre" class="form-control" placeholder="Ej. Juan Pérez">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Contraseña</label>
                        <input type="password" id="nuevo_password" class="form-control" placeholder="Mínimo 6 caracteres">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Rol</label>
                        <select id="nuevo_rol" class="form-select">
                            <option value="usuario" selected>Usuario</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-success" onclick="crearUsuarioDesdeAdmin()">
                        <i class="fas fa-user-plus"></i> Crear Usuario
                    </button>
                    <div id="usuarioStatus" class="text-muted"></div>
                </div>
            </div>
        </div>

        <!-- Carga Masiva de Usuarios desde Excel (TEMPORAL) -->
        <div class="card fade-in mt-4 border-warning">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-file-excel"></i> Carga Masiva de Usuarios desde Excel <span class="badge bg-danger">TEMPORAL</span>
                </span>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>Formato requerido:</strong> El archivo Excel debe tener las columnas: <code>Empleado</code>, <code>Usuario</code>, <code>Contraseña</code> (en ese orden). La primera fila debe contener los encabezados.
                </div>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">
                            <i class="fas fa-file-upload"></i> Seleccionar archivo Excel (.xlsx o .xls)
                        </label>
                        <input type="file" id="excelFileInput" class="form-control" accept=".xlsx,.xls" onchange="previewExcelFile(event)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">
                            <i class="fas fa-user-tag"></i> Rol para usuarios nuevos
                        </label>
                        <select id="rolMasivo" class="form-select">
                            <option value="usuario" selected>Usuario</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>
                <div id="excelPreview" class="mt-3" style="display: none;">
                    <h6>Vista previa (primeras 5 filas):</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead id="excelPreviewHead"></thead>
                            <tbody id="excelPreviewBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary" id="btnCrearUsuarios" onclick="crearUsuariosDesdeExcel()" disabled>
                        <i class="fas fa-users"></i> Crear Usuarios desde Excel
                    </button>
                    <div id="bulkUsuarioStatus" class="text-muted"></div>
                </div>
                <div id="bulkProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div id="bulkProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="bulkProgressText" class="mt-2 text-muted"></div>
                </div>
                <div id="bulkResults" class="mt-3" style="display: none;">
                    <h6>Resultados:</h6>
                    <div id="bulkResultsContent"></div>
                </div>
            </div>
        </div>

        <!-- Eliminar Usuarios -->
        <div class="card fade-in mt-4 border-danger">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-user-times"></i> Eliminar Usuarios
                </span>
                <button class="btn btn-sm btn-outline-light" onclick="cargarListaUsuarios()">
                    <i class="fas fa-sync-alt"></i> Actualizar Lista
                </button>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Advertencia:</strong> Esta acción eliminará permanentemente el usuario del sistema. Esta acción no se puede deshacer.
                </div>
                <div class="mb-3">
                    <input 
                        type="text" 
                        class="form-control" 
                        id="buscarUsuarioEliminar" 
                        placeholder="Buscar usuario por nombre o username..."
                        onkeyup="filtrarUsuariosEliminar()"
                    >
                </div>
                <div id="loadingUsuarios" class="text-center py-4">
                    <div class="loader"></div>
                    <p class="text-muted">Cargando usuarios...</p>
                </div>
                <div id="usuariosContainer" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nombre</th>
                                    <th>Usuario</th>
                                    <th>Rol</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usuariosTableBody">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    <div id="emptyUsuarios" class="empty-state text-center py-4" style="display: none;">
                        <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                        <h5>No se encontraron usuarios</h5>
                        <p class="text-muted">No hay usuarios registrados en el sistema.</p>
                    </div>
                </div>
                <div id="eliminarUsuarioStatus" class="mt-3"></div>
            </div>
        </div>

        <!-- Tabla de Asistencias -->
        <div class="card fade-in">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-list"></i> Todas las Asistencias
                </span>
                <span class="badge bg-white text-primary" id="totalRegistros">0 registros</span>
            </div>
            <div class="card-body">
                <div id="loadingAsistencias" class="text-center">
                    <div class="loader"></div>
                    <p class="text-muted">Cargando asistencias...</p>
                </div>
                
                <div id="asistenciasContainer" style="display: none;">
                    <!-- Buscador -->
                    <div class="mb-3">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="searchInput" 
                            placeholder="Buscar por nombre"
                            onkeyup="filtrarTabla()"
                        >
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="asistenciasTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nombre</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                </tr>
                            </thead>
                            <tbody id="asistenciasBody">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="emptyAsistencias" class="empty-state" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <h3>No hay registros</h3>
                    <p>No se encontraron asistencias para los filtros seleccionados.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ExcelJS para exportación a Excel con logo (CAMBIADO DE SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <!-- SheetJS para lectura de archivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Custom Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/database.js"></script>
    <script src="js/excel-export.js"></script>
    
    <script>
        let todasAsistencias = [];
        let asistenciasFiltradas = [];

        // Verificar autenticación al cargar (requiere admin)
        checkAuth(true)
            .then((user) => {
                document.getElementById('userEmail').textContent = user.email;
                
                // Cargar datos
                cargarEstadisticas();
                cargarAsistencias();
                cargarMenu();
                prepararAppSecundaria();
                configurarRolAdmin();
                cargarListaUsuarios();
                
                // Establecer fecha de hoy en filtros
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('fechaInicio').value = hoy;
                document.getElementById('fechaFin').value = hoy;
            })
            .catch((error) => {
                console.error('Error de autenticación:', error);
            });

        // Cargar estadísticas
        function cargarEstadisticas() {
            obtenerEstadisticas()
                .then((stats) => {
                    document.getElementById('statHoy').textContent = stats.hoy;
                    document.getElementById('statMes').textContent = stats.mes;
                    document.getElementById('statTotal').textContent = stats.total;
                })
                .catch((error) => {
                    console.error('Error al cargar estadísticas:', error);
                });
        }

        // =====================
        // Menú Semanal (admin)
        // =====================
        function uiGetMenuValues() {
            return {
                lunes: (document.getElementById('menu_lunes').value || '').trim(),
                martes: (document.getElementById('menu_martes').value || '').trim(),
                miercoles: (document.getElementById('menu_miercoles').value || '').trim(),
                jueves: (document.getElementById('menu_jueves').value || '').trim(),
                viernes: (document.getElementById('menu_viernes').value || '').trim(),
                sabado: (document.getElementById('menu_sabado').value || '').trim(),
                domingo: (document.getElementById('menu_domingo').value || '').trim(),
            };
        }

        function uiSetMenuValues(menu) {
            document.getElementById('menu_lunes').value = menu.lunes || '';
            document.getElementById('menu_martes').value = menu.martes || '';
            document.getElementById('menu_miercoles').value = menu.miercoles || '';
            document.getElementById('menu_jueves').value = menu.jueves || '';
            document.getElementById('menu_viernes').value = menu.viernes || '';
            document.getElementById('menu_sabado').value = menu.sabado || '';
            document.getElementById('menu_domingo').value = menu.domingo || '';
        }

        function setMenuStatus(message, type = 'muted') {
            const el = document.getElementById('menuStatus');
            el.className = type === 'success' ? 'text-success' : type === 'danger' ? 'text-danger' : 'text-muted';
            el.textContent = message;
        }

        function cargarMenu() {
            setMenuStatus('Cargando menú...');
            obtenerMenuSemanal()
                .then((menu) => {
                    uiSetMenuValues(menu || {});
                    setMenuStatus('Menú cargado', 'success');
                    setTimeout(() => setMenuStatus(''), 2000);
                })
                .catch(() => {
                    setMenuStatus('No se pudo cargar el menú', 'danger');
                });
        }

        function guardarMenu() {
            const btns = document.querySelectorAll('button[onclick="guardarMenu()"]');
            btns.forEach(b => b.disabled = true);
            setMenuStatus('Guardando...');
            const menu = uiGetMenuValues();
            guardarMenuSemanal(menu)
                .then(() => {
                    setMenuStatus('Menú guardado correctamente', 'success');
                })
                .catch(() => {
                    setMenuStatus('Error al guardar el menú', 'danger');
                })
                .finally(() => {
                    btns.forEach(b => b.disabled = false);
                    setTimeout(() => setMenuStatus(''), 2500);
                });
        }

        // =====================
        // Gestión de Usuarios (admin)
        // =====================
        let secondaryApp = null;
        let secondaryAuth = null;

        function prepararAppSecundaria() {
            try {
                if (!secondaryApp) {
                    secondaryApp = firebase.initializeApp(firebase.app().options, 'secondary');
                    secondaryAuth = secondaryApp.auth();
                }
            } catch (e) {
                // Si ya existe, obtener referencias
                secondaryApp = firebase.app('secondary');
                secondaryAuth = secondaryApp.auth();
            }
        }

        // Asegurar que el admin (por email) tenga rol 'admin' en DB
        function configurarRolAdmin() {
            const user = auth.currentUser;
            if (!user) return;
            const esAdminEmail = (user.email === ADMIN_EMAIL);
            if (!esAdminEmail) return;
            const rolRef = database.ref('roles/' + user.uid);
            rolRef.once('value')
                .then((snap) => {
                    const rol = snap.val();
                    if (rol !== 'admin') {
                        return rolRef.set('admin');
                    }
                })
                .catch(() => {
                    // Ignorar; se reflejará al crear usuarios si falla
                });
        }

        function setUsuarioStatus(message, type = 'muted') {
            const el = document.getElementById('usuarioStatus');
            el.className = type === 'success' ? 'text-success' : type === 'danger' ? 'text-danger' : 'text-muted';
            el.textContent = message;
        }

        function construirEmail(username) {
            const limpio = String(username || '').trim().toLowerCase();
            return `${limpio}@empaques.local`;
        }

        function validarCamposUsuario(u, n, p) {
            if (!u || u.length < 3) return 'Usuario inválido';
            if (!n || n.length < 3) return 'Nombre inválido';
            if (!p || p.length < 6) return 'La contraseña debe tener al menos 6 caracteres';
            if (/\s/.test(u)) return 'El usuario no debe contener espacios';
            return '';
        }

        function crearUsuarioDesdeAdmin() {
            const u = document.getElementById('nuevo_usuario').value.trim().toLowerCase();
            const n = document.getElementById('nuevo_nombre').value.trim();
            const p = document.getElementById('nuevo_password').value;
            const r = document.getElementById('nuevo_rol').value;

            const err = validarCamposUsuario(u, n, p);
            if (err) {
                setUsuarioStatus(err, 'danger');
                return;
            }

            setUsuarioStatus('Creando usuario...');

            // Verificar que el username no exista
            database.ref('usernames/' + u).once('value')
                .then((snap) => {
                    if (snap.exists()) {
                        throw new Error('El usuario ya existe');
                    }
                    // Crear en Auth usando app secundaria
                    const email = construirEmail(u);
                    return secondaryAuth.createUserWithEmailAndPassword(email, p)
                        .then((cred) => {
                            const uid = cred.user.uid;
                            // Asignar displayName en el usuario recién creado (app secundaria)
                            return cred.user.updateProfile({ displayName: n })
                                .then(() => ({ uid }));
                        });
                })
                .then(({ uid }) => {
                    // Guardar mapeos en DB: username -> uid, rol, perfil
                    const updates = {};
                    updates['usernames/' + u] = uid;
                    updates['roles/' + uid] = r;
                    updates['perfiles/' + uid] = { username: u, nombre: n };
                    return database.ref().update(updates)
                        .then(() => uid)
                        .catch((err) => {
                            // Si falla la DB, mostrar error concreto y mantener la cuenta de Auth creada
                            throw new Error('Se creó el usuario en Auth pero falló guardar en la base de datos: ' + (err && err.message ? err.message : 'permiso denegado'));
                        });
                })
                .then((uid) => {
                    // Cerrar sesión del secundario para no dejarlo abierto
                    return secondaryAuth.signOut().catch(() => {}).then(() => uid);
                })
                .then(() => {
                    setUsuarioStatus('Usuario creado correctamente', 'success');
                    // Limpiar campos
                    document.getElementById('nuevo_usuario').value = '';
                    document.getElementById('nuevo_nombre').value = '';
                    document.getElementById('nuevo_password').value = '';
                    document.getElementById('nuevo_rol').value = 'usuario';
                    setTimeout(() => setUsuarioStatus(''), 2500);
                })
                .catch((e) => {
                    console.error(e);
                    setUsuarioStatus(e.message || 'Error al crear el usuario', 'danger');
                });
        }

        // Cargar todas las asistencias
        function cargarAsistencias() {
            const loadingAsistencias = document.getElementById('loadingAsistencias');
            const asistenciasContainer = document.getElementById('asistenciasContainer');
            const emptyAsistencias = document.getElementById('emptyAsistencias');
            
            loadingAsistencias.style.display = 'block';
            asistenciasContainer.style.display = 'none';
            emptyAsistencias.style.display = 'none';
            
            obtenerTodasAsistencias()
                .then((asistencias) => {
                    todasAsistencias = asistencias;
                    asistenciasFiltradas = asistencias;
                    mostrarAsistencias(asistencias);
                })
                .catch((error) => {
                    console.error('Error al cargar asistencias:', error);
                    loadingAsistencias.style.display = 'none';
                    emptyAsistencias.style.display = 'block';
                });
        }

        // Mostrar asistencias en la tabla
        function mostrarAsistencias(asistencias) {
            const loadingAsistencias = document.getElementById('loadingAsistencias');
            const asistenciasContainer = document.getElementById('asistenciasContainer');
            const emptyAsistencias = document.getElementById('emptyAsistencias');
            const asistenciasBody = document.getElementById('asistenciasBody');
            const totalRegistros = document.getElementById('totalRegistros');
            
            loadingAsistencias.style.display = 'none';
            
            if (asistencias.length === 0) {
                emptyAsistencias.style.display = 'block';
                asistenciasContainer.style.display = 'none';
            } else {
                asistenciasContainer.style.display = 'block';
                emptyAsistencias.style.display = 'none';
                
                // Actualizar contador
                totalRegistros.textContent = `${asistencias.length} registro${asistencias.length !== 1 ? 's' : ''}`;
                
                // Llenar tabla
                asistenciasBody.innerHTML = '';
                asistencias.forEach((asistencia, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${asistencia.nombre}</td>
                        <td>${formatearFecha(asistencia.fecha)}</td>
                        <td>${asistencia.hora}</td>
                    `;
                    asistenciasBody.appendChild(row);
                });
            }
        }

        // Aplicar filtro de fechas
        function aplicarFiltro() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                alert('Por favor, selecciona ambas fechas.');
                return;
            }
            
            if (fechaInicio > fechaFin) {
                alert('La fecha de inicio no puede ser mayor a la fecha fin.');
                return;
            }
            
            filtrarAsistenciasPorFecha(fechaInicio, fechaFin)
                .then((asistencias) => {
                    asistenciasFiltradas = asistencias;
                    mostrarAsistencias(asistencias);
                })
                .catch((error) => {
                    console.error('Error al filtrar:', error);
                });
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            document.getElementById('searchInput').value = '';
            asistenciasFiltradas = todasAsistencias;
            mostrarAsistencias(todasAsistencias);
        }

        // Ver asistencias de hoy
        function verHoy() {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = hoy;
            document.getElementById('fechaFin').value = hoy;
            aplicarFiltro();
        }

        // Filtrar tabla por búsqueda
        function filtrarTabla() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const filtradas = asistenciasFiltradas.filter((asistencia) => {
                return asistencia.nombre.toLowerCase().includes(searchValue) ||
                       asistencia.email.toLowerCase().includes(searchValue);
            });
            mostrarAsistencias(filtradas);
        }

        // Exportar datos a Excel
        function exportarDatos() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (fechaInicio && fechaFin) {
                exportarPorFecha(fechaInicio, fechaFin);
            } else {
                exportarTodas();
            }
        }

        // Función para formatear fecha
        function formatearFecha(fechaString) {
            const fecha = new Date(fechaString + 'T00:00:00');
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            return fecha.toLocaleDateString('es-ES', opciones);
        }

        // =====================
        // Carga Masiva de Usuarios desde Excel (TEMPORAL)
        // =====================
        let excelData = null;

        function previewExcelFile(event) {
            const file = event.target.files[0];
            if (!file) {
                excelData = null;
                document.getElementById('excelPreview').style.display = 'none';
                document.getElementById('btnCrearUsuarios').disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (jsonData.length < 2) {
                        alert('El archivo Excel debe tener al menos una fila de encabezados y una fila de datos.');
                        excelData = null;
                        document.getElementById('excelPreview').style.display = 'none';
                        document.getElementById('btnCrearUsuarios').disabled = true;
                        return;
                    }

                    // Verificar y mapear encabezados (flexible con variaciones)
                    const headers = jsonData[0].map(h => String(h || '').trim().toLowerCase());
                    
                    // Buscar índices de columnas (flexible)
                    const empleadoIdx = headers.findIndex(h => h.includes('empleado') || h.includes('nombre'));
                    const usuarioIdx = headers.findIndex(h => h.includes('usuario') || h.includes('username'));
                    const contraseñaIdx = headers.findIndex(h => 
                        h.includes('contraseña') || h.includes('contrasena') || h.includes('password') || h.includes('pass')
                    );

                    if (empleadoIdx === -1 || usuarioIdx === -1 || contraseñaIdx === -1) {
                        alert('El archivo Excel debe tener las columnas: Empleado (o Nombre), Usuario, Contraseña. Verifica los encabezados.');
                        excelData = null;
                        document.getElementById('excelPreview').style.display = 'none';
                        document.getElementById('btnCrearUsuarios').disabled = true;
                        return;
                    }

                    // Procesar datos (saltar encabezados)
                    excelData = jsonData.slice(1)
                        .filter(row => row && row.length > 0 && row[empleadoIdx] && row[usuarioIdx] && row[contraseñaIdx])
                        .map(row => ({
                            empleado: String(row[empleadoIdx] || '').trim(),
                            usuario: String(row[usuarioIdx] || '').trim().toLowerCase(),
                            contraseña: String(row[contraseñaIdx] || '').trim()
                        }))
                        .filter(row => row.empleado && row.usuario && row.contraseña);

                    if (excelData.length === 0) {
                        alert('No se encontraron filas válidas en el archivo Excel.');
                        excelData = null;
                        document.getElementById('excelPreview').style.display = 'none';
                        document.getElementById('btnCrearUsuarios').disabled = true;
                        return;
                    }

                    // Mostrar vista previa
                    mostrarVistaPreviaExcel(excelData);
                    document.getElementById('btnCrearUsuarios').disabled = false;
                    setBulkUsuarioStatus(`Archivo cargado: ${excelData.length} usuario(s) encontrado(s)`, 'success');
                } catch (error) {
                    console.error('Error al leer el archivo Excel:', error);
                    alert('Error al leer el archivo Excel. Asegúrate de que sea un archivo válido.');
                    excelData = null;
                    document.getElementById('excelPreview').style.display = 'none';
                    document.getElementById('btnCrearUsuarios').disabled = true;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function mostrarVistaPreviaExcel(data) {
            const previewHead = document.getElementById('excelPreviewHead');
            const previewBody = document.getElementById('excelPreviewBody');
            
            previewHead.innerHTML = '<tr><th>Empleado</th><th>Usuario</th><th>Contraseña</th></tr>';
            previewBody.innerHTML = '';

            const previewRows = data.slice(0, 5);
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.empleado}</td>
                    <td>${row.usuario}</td>
                    <td>${'*'.repeat(row.contraseña.length)}</td>
                `;
                previewBody.appendChild(tr);
            });

            if (data.length > 5) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="3" class="text-center text-muted">... y ${data.length - 5} más</td>`;
                previewBody.appendChild(tr);
            }

            document.getElementById('excelPreview').style.display = 'block';
        }

        function setBulkUsuarioStatus(message, type = 'muted') {
            const el = document.getElementById('bulkUsuarioStatus');
            el.className = type === 'success' ? 'text-success' : type === 'danger' ? 'text-danger' : 'text-muted';
            el.textContent = message;
        }

        async function crearUsuariosDesdeExcel() {
            if (!excelData || excelData.length === 0) {
                setBulkUsuarioStatus('No hay datos para procesar', 'danger');
                return;
            }

            const rol = document.getElementById('rolMasivo').value;
            const total = excelData.length;
            let exitosos = 0;
            let fallidos = 0;
            const errores = [];

            // Deshabilitar botón y mostrar progreso
            document.getElementById('btnCrearUsuarios').disabled = true;
            document.getElementById('bulkProgress').style.display = 'block';
            document.getElementById('bulkResults').style.display = 'none';
            setBulkUsuarioStatus('Iniciando creación de usuarios...', 'muted');

            // Procesar usuarios uno por uno con delay para evitar rate limiting
            for (let i = 0; i < excelData.length; i++) {
                const usuario = excelData[i];
                const progress = Math.round(((i + 1) / total) * 100);
                
                document.getElementById('bulkProgressBar').style.width = progress + '%';
                document.getElementById('bulkProgressText').textContent = 
                    `Procesando ${i + 1} de ${total}: ${usuario.empleado}...`;

                try {
                    await crearUsuarioIndividual(
                        usuario.usuario,
                        usuario.empleado,
                        usuario.contraseña,
                        rol
                    );
                    exitosos++;
                } catch (error) {
                    fallidos++;
                    errores.push({
                        empleado: usuario.empleado,
                        usuario: usuario.usuario,
                        error: error.message || 'Error desconocido'
                    });
                }

                // Pequeño delay para evitar sobrecargar Firebase
                if (i < excelData.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }

            // Mostrar resultados
            document.getElementById('bulkProgress').style.display = 'none';
            document.getElementById('bulkResults').style.display = 'block';
            
            const resultsContent = document.getElementById('bulkResultsContent');
            resultsContent.innerHTML = `
                <div class="alert alert-success">
                    <strong>✓ Exitosos:</strong> ${exitosos} usuario(s) creado(s)
                </div>
                ${fallidos > 0 ? `
                    <div class="alert alert-danger">
                        <strong>✗ Fallidos:</strong> ${fallidos} usuario(s)
                    </div>
                    <details class="mt-2">
                        <summary class="btn btn-sm btn-outline-danger">Ver detalles de errores</summary>
                        <div class="mt-2">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Empleado</th>
                                        <th>Usuario</th>
                                        <th>Error</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${errores.map(e => `
                                        <tr>
                                            <td>${e.empleado}</td>
                                            <td>${e.usuario}</td>
                                            <td class="text-danger">${e.error}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </details>
                ` : ''}
            `;

            if (exitosos > 0) {
                setBulkUsuarioStatus(`✓ ${exitosos} usuario(s) creado(s) exitosamente`, 'success');
            }
            if (fallidos > 0) {
                setBulkUsuarioStatus(`⚠ ${exitosos} exitosos, ${fallidos} fallidos`, 'danger');
            }

            // Habilitar botón nuevamente
            document.getElementById('btnCrearUsuarios').disabled = false;
        }

        function crearUsuarioIndividual(usuario, nombre, contraseña, rol) {
            return new Promise((resolve, reject) => {
                // Validar campos
                const err = validarCamposUsuario(usuario, nombre, contraseña);
                if (err) {
                    reject(new Error(err));
                    return;
                }

                // Verificar que el username no exista
                database.ref('usernames/' + usuario).once('value')
                    .then((snap) => {
                        if (snap.exists()) {
                            throw new Error('El usuario ya existe');
                        }
                        // Crear en Auth usando app secundaria
                        const email = construirEmail(usuario);
                        return secondaryAuth.createUserWithEmailAndPassword(email, contraseña)
                            .then((cred) => {
                                const uid = cred.user.uid;
                                // Asignar displayName
                                return cred.user.updateProfile({ displayName: nombre })
                                    .then(() => ({ uid }));
                            });
                    })
                    .then(({ uid }) => {
                        // Guardar mapeos en DB
                        const updates = {};
                        updates['usernames/' + usuario] = uid;
                        updates['roles/' + uid] = rol;
                        updates['perfiles/' + uid] = { username: usuario, nombre: nombre };
                        return database.ref().update(updates)
                            .then(() => uid)
                            .catch((err) => {
                                throw new Error('Error al guardar en la base de datos: ' + (err && err.message ? err.message : 'permiso denegado'));
                            });
                    })
                    .then((uid) => {
                        // Cerrar sesión del secundario
                        return secondaryAuth.signOut().catch(() => {}).then(() => uid);
                    })
                    .then(() => {
                        resolve();
                    })
                    .catch((e) => {
                        reject(e);
                    });
            });
        }

        // =====================
        // Eliminar Usuarios (admin)
        // =====================
        let todosUsuarios = [];
        let usuariosFiltrados = [];

        function cargarListaUsuarios() {
            const loadingUsuarios = document.getElementById('loadingUsuarios');
            const usuariosContainer = document.getElementById('usuariosContainer');
            const emptyUsuarios = document.getElementById('emptyUsuarios');
            
            loadingUsuarios.style.display = 'block';
            usuariosContainer.style.display = 'none';
            emptyUsuarios.style.display = 'none';

            // Obtener todos los usuarios desde la base de datos
            Promise.all([
                database.ref('usernames').once('value'),
                database.ref('perfiles').once('value'),
                database.ref('roles').once('value')
            ])
            .then(([usernamesSnap, perfilesSnap, rolesSnap]) => {
                const usernames = usernamesSnap.val() || {};
                const perfiles = perfilesSnap.val() || {};
                const roles = rolesSnap.val() || {};

                // Construir lista de usuarios
                todosUsuarios = [];
                Object.keys(usernames).forEach(username => {
                    const uid = usernames[username];
                    const perfil = perfiles[uid] || {};
                    const rol = roles[uid] || 'usuario';

                    todosUsuarios.push({
                        username: username,
                        uid: uid,
                        nombre: perfil.nombre || 'Sin nombre',
                        rol: rol
                    });
                });

                // Ordenar por nombre
                todosUsuarios.sort((a, b) => a.nombre.localeCompare(b.nombre));
                usuariosFiltrados = [...todosUsuarios];
                
                mostrarUsuarios(usuariosFiltrados);
            })
            .catch((error) => {
                console.error('Error al cargar usuarios:', error);
                loadingUsuarios.style.display = 'none';
                emptyUsuarios.style.display = 'block';
                setEliminarUsuarioStatus('Error al cargar la lista de usuarios', 'danger');
            });
        }

        function mostrarUsuarios(usuarios) {
            const loadingUsuarios = document.getElementById('loadingUsuarios');
            const usuariosContainer = document.getElementById('usuariosContainer');
            const emptyUsuarios = document.getElementById('emptyUsuarios');
            const usuariosTableBody = document.getElementById('usuariosTableBody');
            const currentUser = auth.currentUser;

            loadingUsuarios.style.display = 'none';

            if (usuarios.length === 0) {
                usuariosContainer.style.display = 'none';
                emptyUsuarios.style.display = 'block';
            } else {
                usuariosContainer.style.display = 'block';
                emptyUsuarios.style.display = 'none';

                usuariosTableBody.innerHTML = '';
                usuarios.forEach((usuario, index) => {
                    const row = document.createElement('tr');
                    const esUsuarioActual = currentUser && currentUser.uid === usuario.uid;
                    const esAdmin = usuario.rol === 'admin';
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${usuario.nombre}</td>
                        <td><code>${usuario.username}</code></td>
                        <td>
                            <span class="badge ${esAdmin ? 'bg-danger' : 'bg-secondary'}">
                                ${esAdmin ? 'Administrador' : 'Usuario'}
                            </span>
                        </td>
                        <td>
                            ${esUsuarioActual ? 
                                '<span class="text-muted"><i class="fas fa-info-circle"></i> Usuario actual</span>' :
                                `<button class="btn btn-sm btn-danger" onclick="confirmarEliminarUsuario('${usuario.username.replace(/'/g, "\\'")}', '${usuario.uid}', '${usuario.nombre.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>`
                            }
                        </td>
                    `;
                    usuariosTableBody.appendChild(row);
                });
            }
        }

        function filtrarUsuariosEliminar() {
            const searchValue = document.getElementById('buscarUsuarioEliminar').value.toLowerCase();
            usuariosFiltrados = todosUsuarios.filter(usuario => 
                usuario.nombre.toLowerCase().includes(searchValue) ||
                usuario.username.toLowerCase().includes(searchValue)
            );
            mostrarUsuarios(usuariosFiltrados);
        }

        function confirmarEliminarUsuario(username, uid, nombre) {
            if (!confirm(`¿Estás seguro de que deseas eliminar al usuario "${nombre}" (${username})?\n\nEsta acción eliminará:\n- El usuario de la base de datos\n- El usuario de Firebase Authentication\n- Todos los datos asociados\n\nEsta acción NO se puede deshacer.`)) {
                return;
            }

            eliminarUsuario(username, uid, nombre);
        }

        function setEliminarUsuarioStatus(message, type = 'muted') {
            const el = document.getElementById('eliminarUsuarioStatus');
            el.className = type === 'success' ? 'alert alert-success' : type === 'danger' ? 'alert alert-danger' : 'alert alert-info';
            el.innerHTML = message;
            if (type !== 'muted') {
                setTimeout(() => {
                    el.innerHTML = '';
                    el.className = '';
                }, 5000);
            }
        }

        async function eliminarUsuario(username, uid, nombre) {
            setEliminarUsuarioStatus(`Eliminando usuario "${nombre}"...`, 'info');

            try {
                // 1. Eliminar de la base de datos
                const updates = {};
                updates[`usernames/${username}`] = null;
                updates[`roles/${uid}`] = null;
                updates[`perfiles/${uid}`] = null;

                await database.ref().update(updates);

                // 2. Intentar eliminar de Firebase Auth usando la app secundaria
                // Nota: Esto requiere autenticarse como el usuario o usar Admin SDK
                // Por ahora, solo eliminamos de la base de datos
                // El usuario deberá eliminarse manualmente de Firebase Console si es necesario
                
                try {
                    // Intentar obtener el email del usuario desde Auth
                    const email = construirEmail(username);
                    
                    // Nota: No podemos eliminar usuarios de Auth directamente desde el cliente
                    // sin autenticarnos como ese usuario. Esto es una limitación de seguridad.
                    // El usuario quedará en Auth pero sin acceso al sistema.
                    
                    setEliminarUsuarioStatus(
                        `✓ Usuario "${nombre}" eliminado de la base de datos exitosamente.<br>` +
                        `<small>Nota: Si el usuario aún existe en Firebase Authentication, deberás eliminarlo manualmente desde Firebase Console.</small>`,
                        'success'
                    );
                } catch (authError) {
                    // Si falla la eliminación de Auth, aún así reportamos éxito en DB
                    setEliminarUsuarioStatus(
                        `✓ Usuario "${nombre}" eliminado de la base de datos.<br>` +
                        `<small class="text-warning">Advertencia: No se pudo eliminar de Firebase Auth. Elimínalo manualmente desde Firebase Console.</small>`,
                        'success'
                    );
                }

                // Recargar lista
                setTimeout(() => {
                    cargarListaUsuarios();
                }, 1000);

            } catch (error) {
                console.error('Error al eliminar usuario:', error);
                setEliminarUsuarioStatus(
                    `Error al eliminar usuario: ${error.message || 'Error desconocido'}`,
                    'danger'
                );
            }
        }
    </script>
</body>
</html>