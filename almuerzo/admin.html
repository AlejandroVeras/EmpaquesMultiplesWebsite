<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Sistema de Almuerzo</title>
    <link rel="icon" href="../images/logo.png" type="image/x-icon" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/almuerzo.css">
</head>
<body>
    <div class="almuerzo-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <img src="../images/logo.png" alt="Logo Empaques Múltiples" class="logo">
                </div>
                <div class="col-md-6">
                    <div class="user-info">
                        <div class="user-name">
                            <i class="fas fa-user-shield"></i> Administrador
                        </div>
                        <div class="user-email" id="userEmail"></div>
                        <button class="btn btn-sm btn-outline-danger mt-2" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="almuerzo-container">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card fade-in">
                    <div class="stat-number" id="statHoy">-</div>
                    <div class="stat-label">Asistencias Hoy</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card fade-in">
                    <div class="stat-number" id="statMes">-</div>
                    <div class="stat-label">Este Mes</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card fade-in">
                    <div class="stat-number" id="statTotal">-</div>
                    <div class="stat-label">Total Histórico</div>
                </div>
            </div>
        </div>

        <div class="card fade-in mb-4 border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span class="h5 mb-0">
                    <i class="fas fa-utensils me-2"></i> Listado del Almuerzo de Hoy
                </span>
                <span class="badge bg-white text-success fs-6 px-3 py-2 rounded-pill" id="badgeHoyTotal">
                    <i class="fas fa-users"></i> 0 personas
                </span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4" style="width: 150px;">Hora</th>
                                <th>Nombre del Colaborador</th>
                            </tr>
                        </thead>
                        <tbody id="tablaHoyBody">
                            </tbody>
                    </table>
                </div>
                <div id="emptyHoy" class="text-center text-muted py-5" style="display:none;">
                    <i class="fas fa-clock fa-2x mb-2 text-secondary opacity-50"></i>
                    <p class="mb-0">Aún no hay registros para el día de hoy.</p>
                </div>
            </div>
        </div>

        <div class="filter-section fade-in">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i> Fecha Inicio
                    </label>
                    <input type="date" class="form-control" id="fechaInicio">
                </div>
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i> Fecha Fin
                    </label>
                    <input type="date" class="form-control" id="fechaFin">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" onclick="aplicarFiltro()">
                        <i class="fas fa-filter"></i> Filtrar Historial
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100" onclick="exportarDatos()">
                        <i class="fas fa-file-excel"></i> Exportar a Excel
                    </button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-secondary" onclick="limpiarFiltros()">
                        <i class="fas fa-times"></i> Limpiar Filtros
                    </button>
                    <button class="btn btn-outline-info" onclick="verHoy()">
                        <i class="fas fa-calendar-day"></i> Filtrar tabla por Hoy
                    </button>
                </div>
            </div>
        </div>

        <div class="card fade-in mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-burger"></i> Menú Semanal
                </span>
                <button class="btn btn-sm btn-outline-primary" onclick="cargarMenu()">
                    <i class="fas fa-rotate"></i> Recargar
                </button>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Lunes</label>
                        <textarea id="menu_lunes" class="form-control" rows="2" placeholder="Ej. Sopa, arroz, pollo, ensalada"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Martes</label>
                        <textarea id="menu_martes" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Miércoles</label>
                        <textarea id="menu_miercoles" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Jueves</label>
                        <textarea id="menu_jueves" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Viernes</label>
                        <textarea id="menu_viernes" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Sábado</label>
                        <textarea id="menu_sabado" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Domingo</label>
                        <textarea id="menu_domingo" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary" onclick="guardarMenu()">
                        <i class="fas fa-save"></i> Guardar Menú
                    </button>
                    <div id="menuStatus" class="text-muted"></div>
                </div>
            </div>
        </div>

        <div class="card fade-in mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-users-cog"></i> Gestión de Usuarios
                </span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Usuario</label>
                        <input type="text" id="nuevo_usuario" class="form-control" placeholder="Ej. jperez">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nombre y Apellido</label>
                        <input type="text" id="nuevo_nombre" class="form-control" placeholder="Ej. Juan Pérez">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Contraseña</label>
                        <input type="password" id="nuevo_password" class="form-control" placeholder="Mínimo 6 caracteres">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Rol</label>
                        <select id="nuevo_rol" class="form-select">
                            <option value="usuario" selected>Usuario</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-success" onclick="crearUsuarioDesdeAdmin()">
                        <i class="fas fa-user-plus"></i> Crear Usuario
                    </button>
                    <div id="usuarioStatus" class="text-muted"></div>
                </div>
            </div>
        </div>

        <div class="card fade-in mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-file-excel"></i> Creación Masiva de Usuarios
                </span>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Instrucciones:</strong> Suba un archivo Excel con las columnas: <code>usuario</code>, <code>nombre</code>, <code>password</code>, <code>rol</code> (opcional, por defecto 'usuario').
                    <br><small>Descargue la <a href="#" onclick="descargarPlantillaExcel()" class="text-primary">plantilla de ejemplo</a></small>.
                </div>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">
                            <i class="fas fa-file-excel"></i> Archivo Excel
                        </label>
                        <input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls" onchange="validarArchivoExcel()">
                        <div class="form-text">Formatos soportados: .xlsx, .xls</div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-success w-100" onclick="procesarExcelUsuarios()" id="procesarBtn" disabled>
                            <i class="fas fa-upload"></i> Procesar Excel
                        </button>
                    </div>
                </div>
                <div class="mt-3">
                    <div id="excelStatus" class="text-muted"></div>
                    <div id="excelProgress" class="progress mt-2" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div id="excelPreview" class="mt-3" style="display: none;">
                    <h6>Vista previa de usuarios a crear:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="excelPreviewTable">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="confirmarCrearUsuariosExcel()" id="confirmarBtn">
                            <i class="fas fa-check"></i> Confirmar y Crear Usuarios
                        </button>
                        <button class="btn btn-secondary" onclick="cancelarExcel()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card fade-in mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-users"></i> Usuarios Registrados
                </span>
                <button class="btn btn-sm btn-outline-primary" onclick="cargarListaUsuarios()">
                    <i class="fas fa-sync-alt"></i> Actualizar Lista
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="buscarUsuario" 
                            placeholder="Buscar por nombre o username..."
                            onkeyup="filtrarUsuarios()"
                        >
                    </div>
                </div>
                <div id="loadingUsuarios" class="text-center py-4">
                    <div class="loader"></div>
                    <p class="text-muted">Cargando usuarios...</p>
                </div>
                <div id="usuariosContainer" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-primary" id="totalUsuarios">0 usuarios</span>
                        </div>
                        <div class="text-muted small" id="usuariosFiltradosInfo"></div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nombre Completo</th>
                                    <th>Usuario</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usuariosTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
                <div id="emptyUsuarios" class="empty-state text-center py-4" style="display: none;">
                    <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                    <h5>No se encontraron usuarios</h5>
                    <p class="text-muted">No hay usuarios registrados en el sistema o no hay resultados para tu búsqueda.</p>
                </div>
            </div>
        </div>

        <div class="card fade-in">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-list"></i> Historial Completo de Asistencias
                </span>
                <span class="badge bg-white text-primary" id="totalRegistros">0 registros</span>
            </div>
            <div class="card-body">
                <div id="loadingAsistencias" class="text-center">
                    <div class="loader"></div>
                    <p class="text-muted">Cargando historial...</p>
                </div>
                
                <div id="asistenciasContainer" style="display: none;">
                    <div class="mb-3">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="searchInput" 
                            placeholder="Buscar en el historial por nombre..."
                            onkeyup="filtrarTabla()"
                        >
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="asistenciasTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nombre</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                </tr>
                            </thead>
                            <tbody id="asistenciasBody">
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="emptyAsistencias" class="empty-state" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <h3>No hay registros</h3>
                    <p>No se encontraron asistencias para los filtros seleccionados.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/database.js"></script>
    <script src="js/excel-export.js"></script>
    
    <script>
        let todasAsistencias = [];
        let asistenciasFiltradas = [];

        // Verificar autenticación al cargar
        checkAuth(true)
            .then((user) => {
                document.getElementById('userEmail').textContent = user.email;
                
                // Cargar datos
                cargarEstadisticas();
                cargarAsistencias();
                cargarMenu();
                prepararAppSecundaria();
                configurarRolAdmin();
                cargarListaUsuarios();
                
                // Establecer fecha de hoy en filtros
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('fechaInicio').value = hoy;
                document.getElementById('fechaFin').value = hoy;
            })
            .catch((error) => {
                console.error('Error de autenticación:', error);
            });

        function cargarEstadisticas() {
            obtenerEstadisticas()
                .then((stats) => {
                    document.getElementById('statHoy').textContent = stats.hoy;
                    document.getElementById('statMes').textContent = stats.mes;
                    document.getElementById('statTotal').textContent = stats.total;
                })
                .catch((error) => {
                    console.error('Error al cargar estadísticas:', error);
                });
        }

        // =====================
        // Menú Semanal
        // =====================
        function uiGetMenuValues() {
            return {
                lunes: (document.getElementById('menu_lunes').value || '').trim(),
                martes: (document.getElementById('menu_martes').value || '').trim(),
                miercoles: (document.getElementById('menu_miercoles').value || '').trim(),
                jueves: (document.getElementById('menu_jueves').value || '').trim(),
                viernes: (document.getElementById('menu_viernes').value || '').trim(),
                sabado: (document.getElementById('menu_sabado').value || '').trim(),
                domingo: (document.getElementById('menu_domingo').value || '').trim(),
            };
        }

        function uiSetMenuValues(menu) {
            document.getElementById('menu_lunes').value = menu.lunes || '';
            document.getElementById('menu_martes').value = menu.martes || '';
            document.getElementById('menu_miercoles').value = menu.miercoles || '';
            document.getElementById('menu_jueves').value = menu.jueves || '';
            document.getElementById('menu_viernes').value = menu.viernes || '';
            document.getElementById('menu_sabado').value = menu.sabado || '';
            document.getElementById('menu_domingo').value = menu.domingo || '';
        }

        function setMenuStatus(message, type = 'muted') {
            const el = document.getElementById('menuStatus');
            el.className = type === 'success' ? 'text-success' : type === 'danger' ? 'text-danger' : 'text-muted';
            el.textContent = message;
        }

        function cargarMenu() {
            setMenuStatus('Cargando menú...');
            obtenerMenuSemanal()
                .then((menu) => {
                    uiSetMenuValues(menu || {});
                    setMenuStatus('Menú cargado', 'success');
                    setTimeout(() => setMenuStatus(''), 2000);
                })
                .catch(() => {
                    setMenuStatus('No se pudo cargar el menú', 'danger');
                });
        }

        function guardarMenu() {
            const btns = document.querySelectorAll('button[onclick="guardarMenu()"]');
            btns.forEach(b => b.disabled = true);
            setMenuStatus('Guardando...');
            const menu = uiGetMenuValues();
            guardarMenuSemanal(menu)
                .then(() => {
                    setMenuStatus('Menú guardado correctamente', 'success');
                })
                .catch(() => {
                    setMenuStatus('Error al guardar el menú', 'danger');
                })
                .finally(() => {
                    btns.forEach(b => b.disabled = false);
                    setTimeout(() => setMenuStatus(''), 2500);
                });
        }

        // =====================
        // Gestión de Usuarios
        // =====================
        let secondaryApp = null;
        let secondaryAuth = null;

        function prepararAppSecundaria() {
            try {
                if (!secondaryApp) {
                    secondaryApp = firebase.initializeApp(firebase.app().options, 'secondary');
                    secondaryAuth = secondaryApp.auth();
                }
            } catch (e) {
                secondaryApp = firebase.app('secondary');
                secondaryAuth = secondaryApp.auth();
            }
        }

        function configurarRolAdmin() {
            const user = auth.currentUser;
            if (!user) return;
            const esAdminEmail = (user.email === ADMIN_EMAIL);
            if (!esAdminEmail) return;
            const rolRef = database.ref('roles/' + user.uid);
            rolRef.once('value')
                .then((snap) => {
                    const rol = snap.val();
                    if (rol !== 'admin') {
                        return rolRef.set('admin');
                    }
                })
                .catch(() => {});
        }

        function setUsuarioStatus(message, type = 'muted') {
            const el = document.getElementById('usuarioStatus');
            el.className = type === 'success' ? 'text-success' : type === 'danger' ? 'text-danger' : 'text-muted';
            el.textContent = message;
        }

        function construirEmail(username) {
            const limpio = String(username || '').trim().toLowerCase();
            return `${limpio}@empaques.local`;
        }

        function validarCamposUsuario(u, n, p) {
            if (!u || u.length < 3) return 'Usuario inválido';
            if (!n || n.length < 3) return 'Nombre inválido';
            if (!p || p.length < 6) return 'La contraseña debe tener al menos 6 caracteres';
            if (/\s/.test(u)) return 'El usuario no debe contener espacios';
            return '';
        }

        function crearUsuarioDesdeAdmin() {
            const u = document.getElementById('nuevo_usuario').value.trim().toLowerCase();
            const n = document.getElementById('nuevo_nombre').value.trim();
            const p = document.getElementById('nuevo_password').value;
            const r = document.getElementById('nuevo_rol').value;

            const err = validarCamposUsuario(u, n, p);
            if (err) {
                setUsuarioStatus(err, 'danger');
                return;
            }

            setUsuarioStatus('Creando usuario...');

            database.ref('usernames/' + u).once('value')
                .then((snap) => {
                    if (snap.exists()) {
                        throw new Error('El usuario ya existe');
                    }
                    const email = construirEmail(u);
                    return secondaryAuth.createUserWithEmailAndPassword(email, p)
                        .then((cred) => {
                            const uid = cred.user.uid;
                            return cred.user.updateProfile({ displayName: n })
                                .then(() => ({ uid }));
                        });
                })
                .then(({ uid }) => {
                    const updates = {};
                    updates['usernames/' + u] = uid;
                    updates['roles/' + uid] = r;
                    updates['perfiles/' + uid] = { username: u, nombre: n };
                    return database.ref().update(updates)
                        .then(() => uid);
                })
                .then((uid) => {
                    return secondaryAuth.signOut().catch(() => {}).then(() => uid);
                })
                .then(() => {
                    setUsuarioStatus('Usuario creado correctamente', 'success');
                    document.getElementById('nuevo_usuario').value = '';
                    document.getElementById('nuevo_nombre').value = '';
                    document.getElementById('nuevo_password').value = '';
                    document.getElementById('nuevo_rol').value = 'usuario';
                    setTimeout(() => setUsuarioStatus(''), 2500);
                    cargarListaUsuarios();
                })
                .catch((e) => {
                    console.error(e);
                    setUsuarioStatus(e.message || 'Error al crear el usuario', 'danger');
                });
        }

        // =====================
        // Lista de Usuarios
        // =====================
        let todosUsuarios = [];
        let usuariosFiltrados = [];

        function cargarListaUsuarios() {
            const loadingUsuarios = document.getElementById('loadingUsuarios');
            const usuariosContainer = document.getElementById('usuariosContainer');
            const emptyUsuarios = document.getElementById('emptyUsuarios');
            
            loadingUsuarios.style.display = 'block';
            usuariosContainer.style.display = 'none';
            emptyUsuarios.style.display = 'none';

            Promise.all([
                database.ref('usernames').once('value'),
                database.ref('perfiles').once('value'),
                database.ref('roles').once('value')
            ])
            .then(([usernamesSnap, perfilesSnap, rolesSnap]) => {
                const usernames = usernamesSnap.val() || {};
                const perfiles = perfilesSnap.val() || {};
                const roles = rolesSnap.val() || {};

                todosUsuarios = [];
                Object.keys(usernames).forEach(username => {
                    const uid = usernames[username];
                    const perfil = perfiles[uid] || {};
                    const rol = roles[uid] || 'usuario';

                    todosUsuarios.push({
                        username: username,
                        uid: uid,
                        nombre: perfil.nombre || 'Sin nombre',
                        rol: rol
                    });
                });

                todosUsuarios.sort((a, b) => a.nombre.localeCompare(b.nombre));
                usuariosFiltrados = [...todosUsuarios];
                
                mostrarUsuarios(usuariosFiltrados);
            })
            .catch((error) => {
                console.error('Error al cargar usuarios:', error);
                loadingUsuarios.style.display = 'none';
                emptyUsuarios.style.display = 'block';
            });
        }

        function mostrarUsuarios(usuarios) {
            const loadingUsuarios = document.getElementById('loadingUsuarios');
            const usuariosContainer = document.getElementById('usuariosContainer');
            const emptyUsuarios = document.getElementById('emptyUsuarios');
            const usuariosTableBody = document.getElementById('usuariosTableBody');
            const totalUsuarios = document.getElementById('totalUsuarios');
            const usuariosFiltradosInfo = document.getElementById('usuariosFiltradosInfo');
            const currentUser = auth.currentUser;

            loadingUsuarios.style.display = 'none';
            totalUsuarios.textContent = `${todosUsuarios.length} usuario${todosUsuarios.length !== 1 ? 's' : ''}`;
            
            if (usuarios.length === 0) {
                usuariosContainer.style.display = 'none';
                emptyUsuarios.style.display = 'block';
            } else {
                usuariosContainer.style.display = 'block';
                emptyUsuarios.style.display = 'none';

                if (usuarios.length < todosUsuarios.length) {
                    usuariosFiltradosInfo.textContent = `Mostrando ${usuarios.length} de ${todosUsuarios.length} usuarios`;
                } else {
                    usuariosFiltradosInfo.textContent = '';
                }

                usuariosTableBody.innerHTML = '';
                usuarios.forEach((usuario, index) => {
                    const row = document.createElement('tr');
                    const esUsuarioActual = currentUser && currentUser.uid === usuario.uid;
                    const esAdmin = usuario.rol === 'admin';
                    
                    if (index % 2 === 0) row.style.backgroundColor = '#f8f9fa';
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>
                            <strong>${usuario.nombre}</strong>
                            ${esUsuarioActual ? '<span class="badge bg-info ms-2">Tú</span>' : ''}
                        </td>
                        <td><code class="text-primary">${usuario.username}</code></td>
                        <td>
                            <span class="badge ${esAdmin ? 'bg-danger' : 'bg-secondary'}">
                                <i class="fas ${esAdmin ? 'fa-user-shield' : 'fa-user'}"></i> ${esAdmin ? 'Administrador' : 'Usuario'}
                            </span>
                        </td>
                        <td>
                            ${esUsuarioActual ?
                                '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Activo</span>' :
                                '<span class="badge bg-secondary"><i class="fas fa-user"></i> Registrado</span>'
                            }
                        </td>
                        <td>
                            ${esUsuarioActual ?
                                '<span class="text-muted small">No disponible</span>' :
                                `<button class="btn btn-sm btn-danger" onclick="eliminarUsuario('${usuario.uid}', '${usuario.username}')" title="Eliminar usuario"><i class="fas fa-trash"></i> Eliminar</button>`
                            }
                        </td>
                    `;
                    usuariosTableBody.appendChild(row);
                });
            }
        }

        function filtrarUsuarios() {
            const searchValue = document.getElementById('buscarUsuario').value.toLowerCase().trim();
            if (searchValue === '') {
                usuariosFiltrados = [...todosUsuarios];
            } else {
                usuariosFiltrados = todosUsuarios.filter(usuario =>
                    usuario.nombre.toLowerCase().includes(searchValue) ||
                    usuario.username.toLowerCase().includes(searchValue)
                );
            }
            mostrarUsuarios(usuariosFiltrados);
        }

        function eliminarUsuario(uid, username) {
            if (!confirm(`¿Está seguro de que desea eliminar al usuario "${username}"?`)) {
                return;
            }

            if (!confirm('Esta acción eliminará su acceso y todos sus registros. ¿Confirmar?')) {
                return;
            }

            const btn = event.target.closest('button') || event.target;
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const updates = {};
            updates['usernames/' + username] = null; 
            updates['roles/' + uid] = null;          
            updates['perfiles/' + uid] = null;       

            database.ref('asistencias')
                .orderByChild('userId')
                .equalTo(uid)
                .once('value')
                .then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        updates['asistencias/' + childSnapshot.key] = null;
                    });
                    return database.ref().update(updates);
                })
                .then(() => {
                    alert('Usuario eliminado del sistema correctamente.');
                    cargarListaUsuarios();
                })
                .catch((error) => {
                    console.error('Error al eliminar:', error);
                    alert('Hubo un error al eliminar los datos: ' + error.message);
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                });
        }

        // ==========================================
        // LÓGICA DE IMPORTACIÓN MASIVA EXCEL
        // ==========================================
        let usuariosExcelParaProcesar = [];

        function validarArchivoExcel() {
            const input = document.getElementById('excelFile');
            const procesarBtn = document.getElementById('procesarBtn');
            const filePath = input.value;
            const allowedExtensions = /(\.xlsx|\.xls)$/i;

            if (!allowedExtensions.exec(filePath)) {
                alert('Por favor sube un archivo con extensión .xlsx o .xls');
                input.value = '';
                procesarBtn.disabled = true;
                return false;
            }
            procesarBtn.disabled = false;
        }

        function descargarPlantillaExcel() {
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ["usuario", "nombre", "password", "rol"], 
                ["juan.perez", "Juan Pérez", "empaques2025", "usuario"],
                ["maria.g", "María González", "clave123", "admin"]
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Plantilla Usuarios");
            XLSX.writeFile(wb, "plantilla_usuarios_almuerzo.xlsx");
        }

        function procesarExcelUsuarios() {
            const input = document.getElementById('excelFile');
            const file = input.files[0];
            const statusDiv = document.getElementById('excelStatus');
            
            if (!file) return;

            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Leyendo archivo...';

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    statusDiv.innerHTML = '<span class="text-danger">El archivo está vacío.</span>';
                    return;
                }

                const primeraFila = jsonData[0];
                if (!primeraFila.hasOwnProperty('usuario') || !primeraFila.hasOwnProperty('password')) {
                    statusDiv.innerHTML = '<span class="text-danger">Faltan columnas "usuario" y "password".</span>';
                    return;
                }

                usuariosExcelParaProcesar = jsonData;
                mostrarPrevisualizacionExcel(jsonData);
                statusDiv.innerHTML = '';
            };
            reader.readAsArrayBuffer(file);
        }

        function mostrarPrevisualizacionExcel(datos) {
            const previewDiv = document.getElementById('excelPreview');
            const tbody = document.querySelector('#excelPreviewTable tbody');
            tbody.innerHTML = '';

            datos.forEach((fila) => {
                const tr = document.createElement('tr');
                const usuarioValido = fila.usuario && String(fila.usuario).length >= 3;
                const passValido = fila.password && String(fila.password).length >= 6;
                
                const estado = (usuarioValido && passValido) 
                    ? '<span class="badge bg-success">Listo</span>' 
                    : '<span class="badge bg-warning text-dark">Datos inválidos</span>';

                tr.innerHTML = `
                    <td>${fila.usuario || ''}</td>
                    <td>${fila.nombre || ''}</td>
                    <td>${fila.rol || 'usuario'}</td>
                    <td>${estado}</td>
                `;
                tbody.appendChild(tr);
            });

            previewDiv.style.display = 'block';
        }

        function cancelarExcel() {
            document.getElementById('excelFile').value = '';
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('procesarBtn').disabled = true;
            usuariosExcelParaProcesar = [];
        }

        async function confirmarCrearUsuariosExcel() {
            if (usuariosExcelParaProcesar.length === 0) return;

            const confirmBtn = document.getElementById('confirmarBtn');
            const progressDiv = document.getElementById('excelProgress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            const statusDiv = document.getElementById('excelStatus');

            confirmBtn.disabled = true;
            progressDiv.style.display = 'flex';
            let creados = 0;
            let errores = 0;

            prepararAppSecundaria();

            for (let i = 0; i < usuariosExcelParaProcesar.length; i++) {
                const fila = usuariosExcelParaProcesar[i];
                const porcentaje = Math.round(((i + 1) / usuariosExcelParaProcesar.length) * 100);
                progressBar.style.width = `${porcentaje}%`;
                progressBar.textContent = `${porcentaje}%`;

                try {
                    const u = String(fila.usuario || '').trim().toLowerCase().replace(/\s/g, '');
                    const n = String(fila.nombre || 'Usuario Sin Nombre').trim();
                    const p = String(fila.password || '');
                    const r = String(fila.rol || 'usuario').toLowerCase();

                    if (u.length < 3 || p.length < 6) throw new Error('Datos inválidos');

                    const snap = await database.ref('usernames/' + u).once('value');
                    if (snap.exists()) throw new Error('Ya existe');

                    const email = construirEmail(u);
                    const userCred = await secondaryAuth.createUserWithEmailAndPassword(email, p);
                    const uid = userCred.user.uid;

                    await userCred.user.updateProfile({ displayName: n });

                    const updates = {};
                    updates['usernames/' + u] = uid;
                    updates['roles/' + uid] = r;
                    updates['perfiles/' + uid] = { username: u, nombre: n };
                    
                    await database.ref().update(updates);
                    await secondaryAuth.signOut();

                    creados++;
                } catch (error) {
                    console.error(`Error con ${fila.usuario}:`, error);
                    errores++;
                }
            }

            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    Finalizado. <b>Creados:</b> ${creados}, <b>Errores:</b> ${errores}
                </div>
            `;
            
            setTimeout(() => {
                cancelarExcel();
                cargarListaUsuarios();
                progressDiv.style.display = 'none';
                confirmBtn.disabled = false;
            }, 3000);
        }

        // =====================
        // Funciones Tabla General y Panel Hoy
        // =====================
        function cargarAsistencias() {
            const loading = document.getElementById('loadingAsistencias');
            const container = document.getElementById('asistenciasContainer');
            const empty = document.getElementById('emptyAsistencias');
            
            loading.style.display = 'block';
            container.style.display = 'none';
            empty.style.display = 'none';
            
            obtenerTodasAsistencias()
                .then((asistencias) => {
                    todasAsistencias = asistencias;
                    asistenciasFiltradas = asistencias;
                    
                    // Llenar tabla histórica
                    mostrarAsistencias(asistencias);
                    
                    // Llenar tabla de HOY
                    actualizarPanelHoy(asistencias);
                })
                .catch((error) => {
                    console.error('Error al cargar asistencias:', error);
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                });
        }

        function actualizarPanelHoy(todas) {
            const hoy = new Date().toISOString().split('T')[0];
            const delDia = todas.filter(a => a.fecha === hoy);
            
            // Actualizar Badge/Contador
            const badge = document.getElementById('badgeHoyTotal');
            badge.innerHTML = `<i class="fas fa-users"></i> ${delDia.length} personas`;
            
            // Actualizar Tabla (SIN EMAIL)
            const tbody = document.getElementById('tablaHoyBody');
            const empty = document.getElementById('emptyHoy');
            tbody.innerHTML = '';
            
            if (delDia.length === 0) {
                empty.style.display = 'block';
            } else {
                empty.style.display = 'none';
                delDia.forEach(a => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="ps-4 text-success fw-bold">${a.hora.substring(0, 5)}</td>
                        <td>
                            <strong>${a.nombre}</strong>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function mostrarAsistencias(asistencias) {
            const loading = document.getElementById('loadingAsistencias');
            const container = document.getElementById('asistenciasContainer');
            const empty = document.getElementById('emptyAsistencias');
            const body = document.getElementById('asistenciasBody');
            const total = document.getElementById('totalRegistros');
            
            loading.style.display = 'none';
            
            if (asistencias.length === 0) {
                empty.style.display = 'block';
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
                empty.style.display = 'none';
                total.textContent = `${asistencias.length} registro${asistencias.length !== 1 ? 's' : ''}`;
                
                body.innerHTML = '';
                asistencias.forEach((asistencia, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${asistencia.nombre}</td>
                        <td>${formatearFecha(asistencia.fecha)}</td>
                        <td>${asistencia.hora}</td>
                    `;
                    body.appendChild(row);
                });
            }
        }

        function aplicarFiltro() {
            const fi = document.getElementById('fechaInicio').value;
            const ff = document.getElementById('fechaFin').value;
            
            if (!fi || !ff) { alert('Selecciona ambas fechas.'); return; }
            if (fi > ff) { alert('Fecha inicio mayor a fin.'); return; }
            
            filtrarAsistenciasPorFecha(fi, ff)
                .then((asistencias) => {
                    asistenciasFiltradas = asistencias;
                    mostrarAsistencias(asistencias);
                });
        }

        function limpiarFiltros() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            document.getElementById('searchInput').value = '';
            asistenciasFiltradas = todasAsistencias;
            mostrarAsistencias(todasAsistencias);
        }

        function verHoy() {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = hoy;
            document.getElementById('fechaFin').value = hoy;
            aplicarFiltro();
        }

        function filtrarTabla() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            const filtradas = asistenciasFiltradas.filter((a) => {
                return a.nombre.toLowerCase().includes(val) || a.email.toLowerCase().includes(val);
            });
            mostrarAsistencias(filtradas);
        }

        function exportarDatos() {
            const fi = document.getElementById('fechaInicio').value;
            const ff = document.getElementById('fechaFin').value;
            if (fi && ff) exportarPorFecha(fi, ff);
            else exportarTodas();
        }

        function formatearFecha(f) {
            const date = new Date(f + 'T00:00:00');
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
        }
    </script>
</body>
</html>