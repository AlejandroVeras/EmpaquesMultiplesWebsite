<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Sistema de Almuerzo</title>
    <link rel="icon" href="../images/logo.png" type="image/x-icon" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/almuerzo.css">

    <!-- Incluir bcrypt.js para hash de contraseñas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>

</head>
<body>
    <!-- Header -->
    <div class="almuerzo-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <img src="../images/logo.png" alt="Logo Empaques Múltiples" class="logo">
                </div>
                <div class="col-md-6">
                    <div class="user-info">
                        <div class="user-name">
                            <i class="fas fa-user-shield"></i> Administrador
                        </div>
                        <div class="user-email" id="userEmail"></div>
                        <button class="btn btn-sm btn-outline-danger mt-2" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="almuerzo-container">
        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card fade-in">
                    <div class="stat-number" id="statHoy">-</div>
                    <div class="stat-label">Asistencias Hoy</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card fade-in">
                    <div class="stat-number" id="statMes">-</div>
                    <div class="stat-label">Este Mes</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card fade-in">
                    <div class="stat-number" id="statTotal">-</div>
                    <div class="stat-label">Total Histórico</div>
                </div>
            </div>
        </div>

        <!-- Filtros y Exportación -->
        <div class="filter-section fade-in">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i> Fecha Inicio
                    </label>
                    <input type="date" class="form-control" id="fechaInicio">
                </div>
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i> Fecha Fin
                    </label>
                    <input type="date" class="form-control" id="fechaFin">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" onclick="aplicarFiltro()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100" onclick="exportarDatos()">
                        <i class="fas fa-file-excel"></i> Exportar a Excel
                    </button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-secondary" onclick="limpiarFiltros()">
                        <i class="fas fa-times"></i> Limpiar Filtros
                    </button>
                    <button class="btn btn-info" onclick="verHoy()">
                        <i class="fas fa-calendar-day"></i> Ver Hoy
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabla de Asistencias -->
        <div class="card fade-in">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-list"></i> Todas las Asistencias
                </span>
                <span class="badge bg-white text-primary" id="totalRegistros">0 registros</span>
            </div>
            <div class="card-body">
                <div id="loadingAsistencias" class="text-center">
                    <div class="loader"></div>
                    <p class="text-muted">Cargando asistencias...</p>
                </div>
                
                <div id="asistenciasContainer" style="display: none;">
                    <!-- Buscador -->
                    <div class="mb-3">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="searchInput" 
                            placeholder="Buscar por nombre o email..."
                            onkeyup="filtrarTabla()"
                        >
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="asistenciasTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                </tr>
                            </thead>
                            <tbody id="asistenciasBody">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="emptyAsistencias" class="empty-state" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <h3>No hay registros</h3>
                    <p>No se encontraron asistencias para los filtros seleccionados.</p>
                </div>
            </div>
        </div>
    </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SheetJS para exportación a Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Incluir bcrypt.js para hash de contraseñas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    
    <!-- Custom Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/database.js"></script>
    <script src="js/excel-export.js"></script>
    
    <script>
        let todasAsistencias = [];
        let asistenciasFiltradas = [];

        // Verificar autenticación al cargar (requiere admin)
        checkAuth(true)
            .then((user) => {
                document.getElementById('userEmail').textContent = user.email;
                
                // Cargar datos
                cargarEstadisticas();
                cargarAsistencias();
                
                // Establecer fecha de hoy en filtros
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('fechaInicio').value = hoy;
                document.getElementById('fechaFin').value = hoy;
            })
            .catch((error) => {
                console.error('Error de autenticación:', error);
            });

        // Cargar estadísticas
        function cargarEstadisticas() {
            obtenerEstadisticas()
                .then((stats) => {
                    document.getElementById('statHoy').textContent = stats.hoy;
                    document.getElementById('statMes').textContent = stats.mes;
                    document.getElementById('statTotal').textContent = stats.total;
                })
                .catch((error) => {
                    console.error('Error al cargar estadísticas:', error);
                });
        }

        // Cargar todas las asistencias
        function cargarAsistencias() {
            const loadingAsistencias = document.getElementById('loadingAsistencias');
            const asistenciasContainer = document.getElementById('asistenciasContainer');
            const emptyAsistencias = document.getElementById('emptyAsistencias');
            
            loadingAsistencias.style.display = 'block';
            asistenciasContainer.style.display = 'none';
            emptyAsistencias.style.display = 'none';
            
            obtenerTodasAsistencias()
                .then((asistencias) => {
                    todasAsistencias = asistencias;
                    asistenciasFiltradas = asistencias;
                    mostrarAsistencias(asistencias);
                })
                .catch((error) => {
                    console.error('Error al cargar asistencias:', error);
                    loadingAsistencias.style.display = 'none';
                    emptyAsistencias.style.display = 'block';
                });
        }

        // Mostrar asistencias en la tabla
        function mostrarAsistencias(asistencias) {
            const loadingAsistencias = document.getElementById('loadingAsistencias');
            const asistenciasContainer = document.getElementById('asistenciasContainer');
            const emptyAsistencias = document.getElementById('emptyAsistencias');
            const asistenciasBody = document.getElementById('asistenciasBody');
            const totalRegistros = document.getElementById('totalRegistros');
            
            loadingAsistencias.style.display = 'none';
            
            if (asistencias.length === 0) {
                emptyAsistencias.style.display = 'block';
                asistenciasContainer.style.display = 'none';
            } else {
                asistenciasContainer.style.display = 'block';
                emptyAsistencias.style.display = 'none';
                
                // Actualizar contador
                totalRegistros.textContent = `${asistencias.length} registro${asistencias.length !== 1 ? 's' : ''}`;
                
                // Llenar tabla
                asistenciasBody.innerHTML = '';
                asistencias.forEach((asistencia, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${asistencia.nombre}</td>
                        <td>${asistencia.email}</td>
                        <td>${formatearFecha(asistencia.fecha)}</td>
                        <td>${asistencia.hora}</td>
                    `;
                    asistenciasBody.appendChild(row);
                });
            }
        }

        // Aplicar filtro de fechas
        function aplicarFiltro() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                alert('Por favor, selecciona ambas fechas.');
                return;
            }
            
            if (fechaInicio > fechaFin) {
                alert('La fecha de inicio no puede ser mayor a la fecha fin.');
                return;
            }
            
            filtrarAsistenciasPorFecha(fechaInicio, fechaFin)
                .then((asistencias) => {
                    asistenciasFiltradas = asistencias;
                    mostrarAsistencias(asistencias);
                })
                .catch((error) => {
                    console.error('Error al filtrar:', error);
                });
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            document.getElementById('searchInput').value = '';
            asistenciasFiltradas = todasAsistencias;
            mostrarAsistencias(todasAsistencias);
        }

        // Ver asistencias de hoy
        function verHoy() {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = hoy;
            document.getElementById('fechaFin').value = hoy;
            aplicarFiltro();
        }

        // Filtrar tabla por búsqueda
        function filtrarTabla() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const filtradas = asistenciasFiltradas.filter((asistencia) => {
                return asistencia.nombre.toLowerCase().includes(searchValue) ||
                       asistencia.email.toLowerCase().includes(searchValue);
            });
            mostrarAsistencias(filtradas);
        }

        // Exportar datos a Excel
        function exportarDatos() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (fechaInicio && fechaFin) {
                exportarPorFecha(fechaInicio, fechaFin);
            } else {
                exportarTodas();
            }
        }

        // Función para formatear fecha
        function formatearFecha(fechaString) {
            const fecha = new Date(fechaString + 'T00:00:00');
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            return fecha.toLocaleDateString('es-ES', opciones);
        }
    </script>
</body>
</html>
