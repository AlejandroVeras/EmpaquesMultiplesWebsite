<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Almuerzo | Empaques MÃºltiples</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Fuente Google usada en el sitio -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --verde: #116835;
      --verde-oscuro: #0c4725;
      --verde-claro: #e9f4ef;
      --borde-verde: #cfe6da;
      --gris-claro: #f7f7f7;
      --gris-medio: #e0e0e0;
      --negro: #252525;
      --blanco: #fff;
      --error-bg: #ffe9e9;
      --error-color: #8b3030;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--gris-claro);
      font-family: 'Roboto', Arial, sans-serif;
      color: var(--negro);
    }
    .header {
      background: var(--blanco);
      padding: 22px 0 14px 0;
      text-align: center;
      box-shadow: 0 2px 8px #d6e9df;
      margin-bottom: 10px;
    }
    .header .logo {
      display: inline-block;
      vertical-align: middle;
      margin-right: 16px;
    }
    .header img {
      height: 56px;
      max-width: 140px;
      vertical-align: middle;
    }
    .header .titulo {
      display: inline-block;
      vertical-align: middle;
      color: var(--verde);
      font-size: 1.5em;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0px 2px 6px #e9f4ef;
    }
    .container {
      max-width: 410px;
      margin: 28px auto 0 auto;
      background: var(--blanco);
      padding: 32px 24px 24px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 24px #11683522;
    }
    h3, h4 {
      color: var(--verde);
      margin-top: 0;
      margin-bottom: 18px;
      font-weight: 700;
      letter-spacing: .5px;
    }
    input, button {
      width: 100%;
      margin-bottom: 14px;
      padding: 12px 10px;
      border: 1.5px solid var(--borde-verde);
      border-radius: 6px;
      font-size: 1em;
      font-family: inherit;
      box-sizing: border-box;
      background: var(--gris-claro);
      transition: border-color .18s;
    }
    input:focus {
      outline: 2px solid var(--verde);
      border-color: var(--verde);
      background: var(--blanco);
    }
    button {
      background: var(--verde);
      color: var(--blanco);
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: background 0.18s;
      box-shadow: 0 2px 6px #11683518;
      border-radius: 26px;
      font-size: 1.09em;
    }
    button:hover {
      background: var(--verde-oscuro);
    }
    .logout {
      background: var(--gris-claro);
      color: var(--verde);
      border: 1.5px solid var(--verde);
      float: right;
      margin-top: -40px;
      font-size: 0.95em;
      width: auto;
      padding: 7px 16px;
      border-radius: 5px;
      margin-right: -10px;
      transition: background 0.2s, color 0.2s;
    }
    .logout:hover {
      background: var(--verde);
      color: var(--blanco);
    }
    .error {
      color: var(--error-color);
      background: var(--error-bg);
      font-size: 0.96em;
      border-left: 4px solid var(--error-color);
      padding: 7px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
    }
    .hidden {
      display: none;
    }
    ul {
      background: var(--gris-claro);
      border-radius: 4px;
      padding: 10px 13px;
      list-style-type: disc;
      margin: 0 0 10px 0;
      border: 1px solid var(--borde-verde);
    }
    li {
      margin-bottom: 6px;
      font-size: 1em;
      color: var(--negro);
    }
    .fecha {
      color: var(--verde);
      font-weight: bold;
      padding-right: 6px;
      font-size: 0.99em;
    }
    #almuerzo-form input[type="text"] {
      background: var(--verde-claro);
      border-color: var(--verde);
    }
    #almuerzo-form button[type="submit"] {
      margin-top: 4px;
      background: linear-gradient(90deg, #116835 80%, #159e53 100%);
      box-shadow: 0 2px 8px #11683529;
    }
    #register {
      background:var(--gris-claro);
      color:var(--verde);
      border:1.5px solid var(--verde);
      margin-bottom:5px;
    }
    #register:hover {
      background: var(--verde);
      color: var(--blanco);
    }
    .bienvenida {
      background: var(--verde-claro);
      color: var(--verde-oscuro);
      font-weight: 600;
      padding: 9px 12px;
      border-radius: 7px;
      margin-bottom: 10px;
      font-size: 1.02em;
      text-align: center;
      border: 1px solid var(--borde-verde);
    }
    .success {
      background: #e9f4ef;
      color: #116835;
      font-size: 0.98em;
      border-left: 4px solid #116835;
      padding: 7px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-weight: 600;
    }
    @media (max-width: 600px) {
      .container { max-width: 98vw; padding: 18px 6vw; }
      .header img { height: 34px; max-width: 100px; }
      .header .titulo { font-size: 1.12em; }
    }
  </style>
  <!-- Supabase JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
</head>
<body>
  <div class="header">
    <span class="logo"><img src="images/logo.png" alt="Logo Empaques MÃºltiples" /> loading="lazy"</span>
    <span class="titulo">Registro de Almuerzo</span>
  </div>
  <div class="container">
    <button class="logout hidden">Cerrar sesiÃ³n</button>
    <div id="auth">
      <h3>Ingreso de empleado</h3>
      <input type="text" id="usuario" placeholder="Usuario">
      <input type="password" id="password" placeholder="ContraseÃ±a">
      <button id="login">Ingresar</button>
      <button id="register">Registrarse</button>
      <div id="auth-error" class="error"></div>
    </div>
    <div id="main" class="hidden">
      <div id="bienvenida" class="bienvenida"></div>
      <form id="almuerzo-form">
        <input type="text" id="nombre" placeholder="Tu nombre completo" required>
        <button type="submit">Â¡Anotarme para almuerzo hoy!</button>
      </form>
      <div id="form-success" class="success hidden"></div>
      <div id="form-error" class="error"></div>
      <hr>
      <h4>Mis almuerzos Ãºltimos 60 dÃ­as:</h4>
      <ul id="hist-list"></ul>
    </div>
  </div>
  <script>
    // ConfiguraciÃ³n Supabase
    const SUPABASE_URL = 'https://hvhroguawvsztdhvkxpv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2aHJvZ3Vhd3ZzenRkaHZreHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1OTgyNTcsImV4cCI6MjA3MzE3NDI1N30.D_UdP-7b43JUweoYuzfT2OOKy2g2VvigKuJeeeUgVgg';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Estado de sesiÃ³n
    let empleadoActual = null;

    // Elementos
    const authDiv = document.getElementById('auth');
    const mainDiv = document.getElementById('main');
    const loginBtn = document.getElementById('login');
    const registerBtn = document.getElementById('register');
    const logoutBtn = document.querySelector('.logout');
    const usuarioInput = document.getElementById('usuario');
    const passInput = document.getElementById('password');
    const authError = document.getElementById('auth-error');
    const bienvenidaDiv = document.getElementById('bienvenida');
    const form = document.getElementById('almuerzo-form');
    const nombreInput = document.getElementById('nombre');
    const formError = document.getElementById('form-error');
    const formSuccess = document.getElementById('form-success');
    const histList = document.getElementById('hist-list');

    function hoyISO() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }
    function fechaNDiasAtras(n) {
      const d = new Date();
      d.setDate(d.getDate() - n);
      return d.toISOString().slice(0, 10);
    }

    // Login personalizado
    loginBtn.onclick = async () => {
      authError.textContent = '';
      const usuario = usuarioInput.value.trim();
      const password = passInput.value;
      if (!usuario || !password) {
        authError.textContent = "Ingresa usuario y contraseÃ±a.";
        return;
      }
      // Buscar usuario en la tabla empleados
      const { data, error } = await client
        .from('empleados')
        .select('*')
        .eq('usuario', usuario);
      if (error || data.length === 0) {
        authError.textContent = "Usuario o contraseÃ±a incorrectos.";
        return;
      }
      const empleado = data[0];
      // Verificar hash
      const match = bcrypt.compareSync(password, empleado.password_hash);
      if (!match) {
        authError.textContent = "Usuario o contraseÃ±a incorrectos.";
        return;
      }
      empleadoActual = empleado;
      mostrarPrincipal(empleado);
    };

    // Registro personalizado
    registerBtn.onclick = async () => {
      authError.textContent = '';
      const usuario = usuarioInput.value.trim();
      const password = passInput.value;
      const nombre = nombreInput.value.trim();
      if (!usuario || !password || !nombre) {
        authError.textContent = "Completa usuario, nombre y contraseÃ±a.";
        return;
      }
      // Verifica si existe usuario
      const { data: existe } = await client
        .from('empleados')
        .select('*')
        .eq('usuario', usuario);
      if (existe.length > 0) {
        authError.textContent = "Usuario ya existe.";
        return;
      }
      // Genera hash
      const hash = bcrypt.hashSync(password, 10);
      const { error } = await client
        .from('empleados')
        .insert([{ usuario, password_hash: hash, nombre }]);
      if (error) authError.textContent = error.message;
      else authError.textContent = "Â¡Registro exitoso! Ingresa tu usuario y contraseÃ±a.";
    };

    // Logout
    logoutBtn.onclick = () => {
      empleadoActual = null;
      location.reload();
    };

    // Mostrar principal solo empleado
    async function mostrarPrincipal(empleado) {
      authDiv.classList.add('hidden');
      mainDiv.classList.remove('hidden');
      logoutBtn.classList.remove('hidden');
      bienvenidaDiv.textContent = `Â¡Bienvenido, ${empleado.nombre}!`;
      await cargarListaPersonal(empleado);
    }

    // Guardar almuerzo
    form.onsubmit = async (e) => {
      e.preventDefault();
      formError.textContent = '';
      formSuccess.classList.add('hidden');
      if (!empleadoActual) return formError.textContent = "Debes iniciar sesiÃ³n.";
      const nombre = nombreInput.value.trim();
      if (!nombre) return formError.textContent = "Ingresa tu nombre.";
      // Evita duplicados por dÃ­a y usuario
      const { data: yaAnotado, error: errorDup } = await client
        .from('almuerzos')
        .select('*')
        .eq('empleado_id', empleadoActual.id)
        .eq('fecha', hoyISO());
      if (errorDup) return formError.textContent = errorDup.message;
      if (yaAnotado.length > 0) return formError.textContent = "Ya registraste el almuerzo hoy.";
      // Inserta registro
      const { error } = await client
        .from('almuerzos')
        .insert([{ empleado_id: empleadoActual.id, nombre, fecha: hoyISO() }]);
      if (error) formError.textContent = error.message;
      else {
        nombreInput.value = "";
        formSuccess.textContent = "Â¡Registro exitoso!";
        formSuccess.classList.remove('hidden');
        await cargarListaPersonal(empleadoActual);
      }
    };

    // Mostrar lista personal
    async function cargarListaPersonal(empleado) {
      const { data: hist, error } = await client
        .from('almuerzos')
        .select('nombre, fecha')
        .eq('empleado_id', empleado.id)
        .gte('fecha', fechaNDiasAtras(60))
        .order('fecha', { ascending: false });
      histList.innerHTML = hist?.map(x =>
        `<li><span class="fecha">${x.fecha}</span> ${x.nombre}</li>`).join('') || '';
    }
  </script>
</body>
</html>