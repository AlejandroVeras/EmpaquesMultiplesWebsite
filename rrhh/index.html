<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal RRHH - Empaques Múltiples</title>
    <link rel="icon" href="../images/logo.png" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Poppins', sans-serif; }
        .rrhh-header { background-color: #116835; color: white; padding: 15px 0; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #116835; border-color: #116835; }
        .btn-primary:hover { background-color: #0d5128; }
        .login-card { max-width: 400px; margin: 100px auto; }
        #panelRRHH { display: none; }
        /* Loader para transiciones */
        #authLoader { display: none; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="loginView" class="container">
        <div class="card login-card shadow">
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <img src="../images/logo.png" alt="Logo" height="60">
                    <h5 class="mt-3 text-muted">Acceso Recursos Humanos</h5>
                </div>
                
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-user"></i> Usuario o Correo</label>
                        <input type="text" id="userInput" class="form-control" placeholder="Ej. admin o jperez" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-lock"></i> Contraseña</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100" id="btnLogin">
                        Entrar <i class="fas fa-sign-in-alt ms-2"></i>
                    </button>
                    
                    <div id="authLoader">
                        <div class="spinner-border text-success" role="status"></div>
                        <p class="small text-muted mt-2">Verificando permisos...</p>
                    </div>

                    <div id="loginError" class="alert alert-danger mt-3 small" style="display:none;"></div>
                </form>
            </div>
        </div>
    </div>

    <div id="panelRRHH">
        <div class="rrhh-header">
            <div class="container d-flex justify-content-between align-items-center">
                <h4 class="m-0"><i class="fas fa-users-cog"></i> Gestión de Vacantes</h4>
                <div class="d-flex align-items-center gap-3">
                    <small id="adminEmailDisplay" class="text-white-50 d-none d-md-block"></small>
                    <button class="btn btn-outline-light btn-sm" onclick="cerrarSesion()">
                        Salir <i class="fas fa-sign-out-alt ms-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold text-success">
                            <i class="fas fa-plus-circle"></i> Nueva Vacante
                        </div>
                        <div class="card-body">
                            <form id="vacanteForm">
                                <div class="mb-2"><label class="small text-muted">Título</label><input type="text" id="titulo" class="form-control" required></div>
                                <div class="mb-2"><label class="small text-muted">Departamento</label><input type="text" id="depto" class="form-control" required></div>
                                <div class="mb-2"><label class="small text-muted">Tipo</label>
                                    <select id="tipo" class="form-select">
                                        <option>Tiempo Completo</option><option>Medio Tiempo</option><option>Remoto</option><option>Temporal</option>
                                    </select>
                                </div>
                                <div class="mb-2"><label class="small text-muted">Descripción</label><textarea id="desc" class="form-control" rows="3" required></textarea></div>
                                <div class="mb-3"><label class="small text-muted">Requisitos (separar con comas)</label><textarea id="req" class="form-control" rows="2"></textarea></div>
                                <button type="submit" class="btn btn-primary w-100">Publicar</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                            <span>Vacantes Activas</span>
                            <span class="badge bg-success" id="totalVacantes">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div id="listaVacantes" class="list-group list-group-flush">
                                <div class="text-center p-4 text-muted">
                                    <div class="spinner-border spinner-border-sm text-success" role="status"></div> Cargando...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script src="../almuerzo/js/firebase-config.js"></script>
    
    <script>
        // === LÓGICA DE SEGURIDAD RRHH ===
        
        // Reutilizamos las variables globales de firebase-config.js
        const db = database; 
        
        // Elementos UI
        const loginView = document.getElementById('loginView');
        const panelView = document.getElementById('panelRRHH');
        const errorDiv = document.getElementById('loginError');
        const loader = document.getElementById('authLoader');
        const btnLogin = document.getElementById('btnLogin');

        // Función para validar si es admin
        async function verificarAdmin(user) {
            // 1. Lista blanca de correos maestros
            const adminsFijos = ['admin@casaempaques.com', 'soporte.it.casaempaques@gmail.com'];
            if (adminsFijos.includes(user.email)) return true;

            // 2. Verificar rol en base de datos
            try {
                const snapshot = await db.ref('roles/' + user.uid).once('value');
                const rol = snapshot.val();
                return rol === 'admin';
            } catch (e) {
                console.error("Error verificando rol:", e);
                return false;
            }
        }

        // 1. LISTENER DE ESTADO DE AUTENTICACIÓN
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // El usuario se logueó, PERO debemos verificar si es admin
                const esAdmin = await verificarAdmin(user);
                
                if (esAdmin) {
                    // Es admin: Mostrar panel
                    loginView.style.display = 'none';
                    panelView.style.display = 'block';
                    document.getElementById('adminEmailDisplay').textContent = user.email;
                    cargarVacantes();
                } else {
                    // NO es admin: Cerrar sesión forzosamente y mostrar error
                    await auth.signOut();
                    mostrarError("No tienes permisos de administrador para acceder a esta área.");
                    loginView.style.display = 'block';
                    panelView.style.display = 'none';
                }
            } else {
                // No hay usuario logueado
                loginView.style.display = 'block';
                panelView.style.display = 'none';
            }
        });

        // 2. FUNCIÓN DE LOGIN
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // UI Loading
            errorDiv.style.display = 'none';
            btnLogin.style.display = 'none';
            loader.style.display = 'block';

            const inputUser = document.getElementById('userInput').value.trim();
            const pass = document.getElementById('password').value;
            
            // Autocompletar dominio si es necesario
            let emailFinal = inputUser;
            if (!emailFinal.includes('@')) {
                emailFinal = `${emailFinal}@empaques.local`;
            }

            try {
                // Intentar login
                await auth.signInWithEmailAndPassword(emailFinal, pass);
                // El onAuthStateChanged se encargará de la redirección o el bloqueo
            } catch (error) {
                console.error(error);
                let msg = "Error de acceso.";
                if(error.code === 'auth/user-not-found') msg = "Usuario no encontrado.";
                if(error.code === 'auth/wrong-password') msg = "Contraseña incorrecta.";
                if(error.code === 'auth/invalid-email') msg = "Formato de usuario incorrecto.";
                
                mostrarError(msg);
                
                // Restaurar UI
                btnLogin.style.display = 'block';
                loader.style.display = 'none';
            }
        });

        function mostrarError(msg) {
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            
            // Restaurar UI si venimos de un logout forzado
            btnLogin.style.display = 'block';
            loader.style.display = 'none';
        }

        function cerrarSesion() {
            auth.signOut();
        }

        // ==========================================
        // LÓGICA DE GESTIÓN (CRUD)
        // ==========================================

        // Publicar Vacante
        document.getElementById('vacanteForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            db.ref('vacantes').push({
                titulo: document.getElementById('titulo').value,
                departamento: document.getElementById('depto').value,
                tipo: document.getElementById('tipo').value,
                descripcion: document.getElementById('desc').value,
                requisitos: document.getElementById('req').value,
                fecha: new Date().toISOString()
            }).then(() => {
                document.getElementById('vacanteForm').reset();
                alert("Vacante publicada correctamente");
            }).catch(err => {
                alert("Error: " + err.message);
            }).finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        });

        // Cargar Vacantes en tiempo real
        function cargarVacantes() {
            db.ref('vacantes').on('value', snapshot => {
                const lista = document.getElementById('listaVacantes');
                const badge = document.getElementById('totalVacantes');
                lista.innerHTML = '';
                
                if (snapshot.exists()) {
                    let count = 0;
                    snapshot.forEach(child => {
                        count++;
                        const v = child.val();
                        const item = document.createElement('div');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';
                        item.innerHTML = `
                            <div>
                                <h6 class="mb-0 fw-bold text-success">${v.titulo}</h6>
                                <small class="text-muted"><i class="fas fa-building"></i> ${v.departamento} | <span class="badge bg-light text-dark border">${v.tipo}</span></small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="borrar('${child.key}')" title="Eliminar vacante">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        lista.appendChild(item);
                    });
                    badge.textContent = count;
                } else {
                    lista.innerHTML = '<div class="p-4 text-center text-muted">No hay vacantes activas actualmente.</div>';
                    badge.textContent = '0';
                }
            });
        }

        function borrar(id) {
            if(confirm("¿Estás seguro de eliminar esta vacante? Se borrará de la página web inmediatamente.")) {
                db.ref('vacantes/' + id).remove();
            }
        }
    </script>
</body>
</html>